## ARP(地址解析协议)

> 根据网络层IP数据包包头中的IP地址信息解析出目标硬件地址（MAC地址）信息。

步骤：

* 主机A在自己的本地ARP缓存中检查主机B的匹配MAC地址。
* ARP缓存中没有找到映射时，它将询问192.168.1.2的硬件地址，从而将**ARP请求帧广播到本地网络上的所有主机。**(源主机A的IP地址和MAC地址都包括在ARP请求中)
* **本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。**
  * 如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。
* **主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址映射添加到本地ARP缓存中。**
* **主机B将包含其MAC地址的ARP回复消息直接发送回主机A。**
* 当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。
  * 主机缓存是有生存期的，生存期结束后，将再次重复上述过程。
  * 主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信。

### ARP缓存表

​		ARP缓存表是用来存储IP地址和MAC地址的缓冲区，其本质就是一个IP地址 -> MAC地址的对应表。表中的每一项都分别对应这网络上的另一台主机的ip地址和对应的Mac地址。

​	ARP缓存可以包含动态和静态项目。动态项目随时间推移自动添加和删除。

### ARP报文格式

![](https://github.com/daqi17/AndroidBlog/blob/master/img/%E7%BD%91%E7%BB%9C/IP/ARP报文.png)

### ARP命令

win + r ,输入arp -a查看当前主机的arp缓冲列表。

### ARP欺骗

​		APR请求为广播形式发送的，网络上的主机可以自主发送ARP应答消息，并且当其他主机收到应答报文时不会检测该报文的真实性就将其记录在本地的MAC地址转换表。

​		攻击者可以向目标主机发送伪ARP应答报文，从而篡改本地的MAC地址表。

​		ARP欺骗可以导致目标计算机与网关通信失败，更会导致通信重定向。

## ICMP(Internet控制报文协议)

> IP数据包在发送途中一旦发生异常导致无法到达对端目标地址时，需要给发送端发送一个发生异常的通知。
>
> 控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。
>
> ICMP协议是一种**面向无连接**的协议

### 报文格式

ICMP报文包含在IP数据报中，IP头部就在ICMP报文的前面。

ICMP报文包括IP头部、ICMP头部和ICMP报文。

**IP头部的Protocol值为1就说明这是一个ICMP报文**，此外还有一个代码（Code）域用于详细说明某种ICMP报文的类型，所有数据都在ICMP头部后面。

![](https://github.com/daqi17/AndroidBlog/blob/master/img/%E7%BD%91%E7%BB%9C/IP/ICMP报文.png)

### ICMP类型

主要的ICMP消息类型包括以下几种:

* 响应请求
  * ping就是响应请求（Type=8）和应答（Type=0）。
* 时间戳
  * 时间戳请求报文（Type = 13）和时间戳应答报文（Type = 14）用于测试两台主机之间数据报来回一次的传输时间。
* 目标不可到达
  * 目标不可达报文（Type = 3）在路由器或主机不能传递数据报时使用。
  * 常见的不可到达类型还有网络不可到达(Code = 0)、主机不可到达（Code = 1）、协议不可到达（Code = 2）、端口不可到达（Code = 3）
* 源抑制
  * 源抑制报文（Type = 4）一般被接收设备用于帮助防止它们的缓存溢出。接收设备通过发送源抑制报文来请求源设备降低当前的数据发送速度。
  * 由于ICMP没有恢复传输的报文，所以只要停止该报文，主机就会逐渐恢复传输速率。
  * 接收设备由于缓存溢出而开始丢弃数据，然后接受设备开始向源设备发送源抑制报文，其发送速度是每丢弃一个数据包就发送一个源抑制报文。
* 超时报文
  * 数据报丢失，或者长时间在网络游荡而找不到目标，或者拥塞导致主机在规定时间内无法重组数据报分段，这时就要触发ICMP超时报文(Type = 11)的产生。
  * Code = 0表示传输超时，Code = 1 表示重组分段超时。
  * IP包中存在生命周期字段，它的值随着每经过一次路由器就会减1，知道减到0时该IP包会被丢弃。此时，IP路由器会发送一个ICMP超时的消息给发送端主机，并通知该包已被丢弃。

## DHCP

为了实现自动设置IP地址、统一管理IP地址分配，就产生了DHCP协议。

要使用DHCP之前，首先需要架设一台DHCP服务器。然后将DHCP所要分配的IP地址设置到服务器上。还需要将相应的子网掩码、路由控制信息以及DNS服务器的地址等设置到服务器上。

很多时候该网段的路由器会充当DHCP

DHCP在分片IP地址有两种方法（两者可同时使用）：

* 由DHCP服务器在特定的IP地址中自动选出一个进行分配。
* 针对MAC地址分配一个固定的IP地址。

在发送DHCP发现包与DHCP请求包时，DHCP即插即用的IP地址尚未确定。因此，DHCP发现包的目标地址为广播地址255.255.255.255，而源地址为0.0.0.0，表示未知。

## 参考资料

[《图解TCP/IP》](https://github.com/daqi17/AndroidBlog/blob/master/%E7%94%B5%E5%AD%90%E4%B9%A6/%E3%80%8A%E5%9B%BE%E8%A7%A3TCP%20IP(%E7%AC%AC5%E7%89%88).pdf)